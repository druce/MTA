version: 2

models:
  - name: mta_staging
    description: Deduplicate, clean up timestamps and labels, prep for diff
    config:
      materialized: table
      tags: ['SQL']

  - name: mta_diff
    description: First-difference the turnstile counters, keeping 0 <= diff <= 7200
    config:
      materialized: table
      tags: ['SQL']

  - name: entry_avg
    description: Compute ENTRIES observation counts, means and SDs by turnstile for anomaly detection
    config:
      materialized: table
      tags: ['SQL']

  - name: exit_avg
    description: Compute EXITS observation counts, means and SDs and a cutoff by turnstile
    config:
      materialized: table
      tags: ['SQL']

  - name: mta_clean
    description: SQL Drop rows based on the computed cutoff, merge from station_map
    columns:
    - name: DATE_TIME
    - name: STATION
      tests:
        - not_null
    - name: pretty_name
    - name: TURNSTILE
    - name: entries
    - name: exits
    - name: Latitude
    - name: Longitude
    - name: CBD
    - name: borough
    - name: entries_cutoff
    - name: exits_cutoff
    config:
      materialized: table
      tags: ['SQL']

  - name: station_daily
    description: Sum stations by day
    config:
      materialized: table
      tags: ['SQL']

  - name: station_hourly
    description: Sum stations by day and hour
    config:
      materialized: table
      tags: ['SQL']
